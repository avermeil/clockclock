<!DOCTYPE html>
<html>

<head>
    <title>THE CLOCKENING</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yegor256/tacit@gh-pages/tacit-css.min.css" />
</head>

<body>
    <section>
        <header>
            <h1 style="margin-top:32px">THE CLOCKENING</h1>
        </header>
        <article>

            <p><b>Attached Boards</b> <span id="boardCount"></span>: <span id="boards">unknown</span></p>

            <form id="setupForm" action="javascript:getCalibrationData()">
                <fieldset>
                    <label for="ip">IP address</label>
                    <input type="text" name="ip" value="192.168.1.112" />
                    <button type="button" onclick="javascript:probe()">Probe attached boards</button>
                    <label for="ip">Hand</label>
                    <select name="hand">
                        <option value="0" selected>Hand 1</option>
                        <option value="1">Hand 2</option>
                        <option value="2">Hand 3</option>
                        <option value="3">Hand 4</option>
                    </select>
                    <label for="board">Board</label>
                    <select name="board" id="boardinput"></select>

                    <button type="submit">Get Calibration</button>
                </fieldset>

            </form>
            <form id="calibrationForm" action="javascript:setCalibrationData()">
                <fieldset>
                    <h4>Hall Position</h4>
                    <label for="hall">Hall Sensor Position</label>
                    <input name="hall" type="number" min=0 max=4319 required />
                    <button onclick="javascript:setCalibrationData()" type="submit">Calibrate</button>
                </fieldset>
            </form>
            <form id="movementForm" action="javascript:setHandPosition()">
                <h4>Hand Position</h4>

                Moves to
                <input name="pos" type="number" min=0 max=4319 required />
                at
                <input name="speed" type="number" min=0 max=5000 value="1000" required /> speed with
                <select name="extraturns">
                    <option value="0">no extra turns</option>
                    <option value="1">1 extra turn</option>
                    <option value="2">2 extra turns</option>
                </select>
                <select name="clockwise">
                    <option value="0">c-clockwise</option>
                    <option value="1" selected>clockwise</option>
                </select>
                <br />

                <br />
                <button onclick="javascript:preset(7)" class="arrow" type="button">&nwarr;</button>
                <button onclick="javascript:preset(0)" class="arrow" type="button">&uarr;</button>
                <button onclick="javascript:preset(1)" class="arrow" type="button">&nearr;</button>
                <br />
                <button onclick="javascript:preset(6)" class="arrow" type="button">&larr;</button>
                <button class="arrow" type="submit">!</button>
                <button onclick="javascript:preset(2)" class="arrow" type="button">&rarr;</button>
                <br />
                <button onclick="javascript:preset(5)" class="arrow" type="button">&swarr;</button>
                <button onclick="javascript:preset(4)" class="arrow" type="button">&darr;</button>
                <button onclick="javascript:preset(3)" class="arrow" type="button">&searr;</button>
                </fieldset>
            </form>
        </article>

        <footer>
            <nav>
                <ul>
                    <li>
                        <small>Made by Axel Vermeil</a>. <a target="_blank"
                                href="https://github.com/avermeil/clockclock/">View source.</a></small>
                    </li>
                </ul>
            </nav>

        </footer>
    </section>

    <script>

        async function probe() {
            const attachedDevices = await request('probe')

            document.getElementById("boardCount").innerText = `(${attachedDevices.length})`
            document.getElementById("boards").innerHTML = attachedDevices.map(b => `<code>${b}</code>`).join('')
            document.getElementById("boardinput").innerHTML = attachedDevices.map(b => `<option value="${b}">Board #${b}</option>`).join('')

        }

        async function getCalibrationData() {
            const { board, hand } = document.getElementById("setupForm").elements;

            const hallPositions = await request('gethall?board=' + board.value)

            const { hall } = document.getElementById("calibrationForm").elements;

            hall.value = hallPositions[+hand.value]
        }

        async function setCalibrationData() {
            const { board, hand } = document.getElementById("setupForm").elements
            const { hall } = document.getElementById("calibrationForm").elements;

            await request(`sethall?board=${board.value}&hand=${hand.value}&pos=${hall.value}`)
        }

        async function setHandPosition(handName) {
            const setup = document.getElementById("setupForm").elements
            const inputs = document.getElementById("movementForm").elements;

            const board = setup.board.value
            const hand = setup.hand.value
            const pos = inputs.pos.value
            const speed = inputs.speed.value
            const extraturns = inputs.extraturns.value
            const clockwise = inputs.clockwise.value

            // byte board, byte hand, int handPos, byte extraTurns, bool clockwise, int speed
            await request(`sethand?board=${board}&hand=${hand}&pos=${pos}&extraturns=${extraturns}&clockwise=${clockwise}&speed=${speed}`)
        }

        async function preset(i) {
            const inputs = document.getElementById("movementForm").elements
            inputs.pos.value = i * (4320 / 8)
            setHandPosition('hand1')
        }

        async function request(path) {
            const { ip } = document.getElementById("setupForm").elements;


            const response = await fetch(`http://${ip.value}/${path}`, {})

            return response.json()
        }

        probe()

    </script>
</body>

</html>
<style>
    .arrow {
        width: 60px;
        height: 60px;
        margin-bottom: 0.7rem;
    }

    body {
        /* mustard yum */
        background-color: rgb(255, 219, 88);
    }

    article {
        border-radius: 10px;
    }
</style>